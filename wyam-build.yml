# Wyam build pipeline
# Publishes content produced by Wyam to an Artifact named 'content'
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
 branches:
    include:
    - master
pr: none

variables:
  - group: blog

pool:
  vmImage: 'windows-latest'

stages:
- stage: Build
  jobs:
  - job: wyam
    steps:
    - pwsh: dotnet tool install -g Wyam.Tool
      displayName: 'install wyam global tool'

    - pwsh: pwsh -C $env:USERPROFILE\.dotnet\tools\wyam build -o $(Build.ArtifactStagingDirectory)\content
      displayName: 'build site'
    - pwsh: ls -l .
      displayName: 'list cwd'
    - pwsh: ls -l $(Build.ArtifactStagingDirectory)
      displayName: 'list stage'
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)\content\'
        ArtifactName: 'content'
        publishLocation: 'Container'

- stage: Deploy
  jobs:
  - job: CopyBlob
    steps:
    - download: current
      artifact: content
    - task: AzureFileCopy@3
      displayName: copy
      inputs:
        sourcePath: $(Pipeline.Workspace)/content
        azureSubscription: michael-azure
        destination: azureBlob
        storage: $(StorageAccountName)
        containerName: $(StorageContainer)
        cleanTargetBeforeCopy: true
    - task: AzureCLI@2
      displayName: set-cache-control
      inputs:
        azureSubscription: 'michael-azure'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          for i in `az storage blob list --container-name "`$web" --output table | awk '{print $1}'| sed '1,2d' | sed '/^$/d'` ; do
           echo $i
          done